name: Send File Data to Endpoint

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12.3"

      - name: Installing dependencies
        run: pip3 install -r scripts/gha/requirements.txt

      - name: Run processor for changed files under notes/
        shell: bash

        run: |

          # Determine the base commit (BEFORE) and handle the case of the first push to a branch.
          # On the first push, GitHub sets "before" to 40 zeros, meaning there is no previous commit.
          BEFORE="${{ github.event.before }}"
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE="$(git rev-parse HEAD^ 2>/dev/null || echo HEAD)"
          fi

          # Get the list of ADDED or MODIFIED files under the "notes/" directory
          mapfile -t CHANGED < <(git diff --name-only --diff-filter=AM "$BEFORE" "${{ github.sha }}" -- notes/)

          # Get the list of DELETED files under the "notes/" directory
          mapfile -t DELETED < <(git diff --name-only --diff-filter=D "$BEFORE" "${{ github.sha }}" -- notes/)

          # Run the Python processor for added/modified files
          if (( ${#CHANGED[@]} )); then
            echo "Processing changed files: ${CHANGED[*]}"
            python3 -m scripts.gha.process "${CHANGED[@]}"
          else
            echo "No added or modified files under notes/."
          fi

          # Run the deletion handler for deleted files
          if (( ${#DELETED[@]} )); then
            echo "Processing deleted files: ${DELETED[*]}"
            python3 -m scripts.gha.delete "${DELETED[@]}"
          else
            echo "No deleted files under notes/."
          fi
